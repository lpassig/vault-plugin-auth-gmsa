# üéâ Updated Plugin Deployed - Next Steps

## ‚úÖ What Was Deployed

The **updated Vault gMSA plugin** with **HTTP Negotiate protocol support** has been successfully deployed!

### Plugin Details:
- **Version**: v0.1.0 (with HTTP Negotiate support)
- **SHA256**: `0d140e423aaccb3f9d126ac745efab795c229bda728885d4239bef7ad3cda04f`
- **Location**: `/vault/plugins/vault-plugin-auth-gmsa` (in Docker container)
- **Enabled at**: `auth/gmsa/`

### Configuration Status:
- ‚úÖ Plugin registered and enabled
- ‚úÖ Roles created (`vault-gmsa-role`, `default`)
- ‚úÖ Policy created (`vault-gmsa-policy`)
- ‚úÖ Header passthrough configured (`Authorization`, `WWW-Authenticate`)
- ‚ö†Ô∏è  **Keytab NOT configured yet** (need to add it)

---

## üö® CRITICAL: Keytab Configuration Required

The plugin is deployed but **needs the keytab** to validate SPNEGO tokens.

### Option 1: Use Existing Keytab (Recommended)
If you have the base64 keytab from earlier:

```bash
ssh lennart@107.23.32.117

# Set environment
export VAULT_ADDR='https://127.0.0.1:8200'
export VAULT_SKIP_VERIFY=1

# Configure with keytab
vault write auth/gmsa/config \
    realm="LOCAL.LAB" \
    kdcs="ADDC.local.lab:88" \
    spn="HTTP/vault.local.lab" \
    keytab="<BASE64_KEYTAB_HERE>" \
    clock_skew_sec=300
```

### Option 2: Generate New Keytab
If you don't have the keytab, generate a new one on your **Windows Domain Controller**:

#### On ADDC (PowerShell as Administrator):
```powershell
# Method 1: Using extract-aes-key.ps1 (from your repo)
git pull
.\extract-aes-key.ps1

# This will output the AES256 hex key
# Copy the hex key
```

#### On Vault Server (Linux):
```bash
# Get the hex key from Windows
HEX_KEY="<paste_hex_key_here>"

# SSH to Vault server
ssh lennart@107.23.32.117

# Create keytab inside Docker container
CONTAINER_ID=c7db14781e99

sudo docker exec -it $CONTAINER_ID bash

# Inside container:
cd /tmp

# Create keytab using ktutil
ktutil <<EOF
addent -password -p HTTP/vault.local.lab@LOCAL.LAB -k 1 -e aes256-cts-hmac-sha1-96
$HEX_KEY
wkt vault-gmsa.keytab
q
EOF

# Base64 encode
cat vault-gmsa.keytab | base64 -w0

# Copy the base64 output
exit

# Configure Vault
export VAULT_ADDR='https://127.0.0.1:8200'
export VAULT_SKIP_VERIFY=1

vault write auth/gmsa/config \
    realm="LOCAL.LAB" \
    kdcs="ADDC.local.lab:88" \
    spn="HTTP/vault.local.lab" \
    keytab="<BASE64_KEYTAB_HERE>" \
    clock_skew_sec=300
```

---

## üîç How HTTP Negotiate Protocol Works

The updated plugin now supports **TWO authentication methods**:

### Method 1: HTTP Negotiate (NEW - Automatic SPNEGO)
```
Client ‚Üí Vault: POST /v1/auth/gmsa/login
                Headers: Authorization: Negotiate <auto-generated-SPNEGO>
                Body: {"role": "vault-gmsa-role"}

Vault ‚Üí Client: 200 OK
                Body: {"auth": {"client_token": "hvs.CAES..."}}
```

**Benefits**:
- ‚úÖ Windows automatically generates SPNEGO via `UseDefaultCredentials`
- ‚úÖ No manual token generation needed
- ‚úÖ Standard HTTP authentication flow

### Method 2: Legacy (SPNEGO in Body)
```
Client ‚Üí Vault: POST /v1/auth/gmsa/login
                Body: {"role": "vault-gmsa-role", "spnego": "<manually-generated-token>"}

Vault ‚Üí Client: 200 OK
                Body: {"auth": {"client_token": "hvs.CAES..."}}
```

**When used**:
- Fallback if HTTP Negotiate fails
- Requires manual SPNEGO token generation (curl.exe, SSPI)

---

## üöÄ Test the Windows Client Now

Once the keytab is configured, your Windows client should work!

### On Windows Client:
```powershell
# Re-run the client
Start-ScheduledTask -TaskName 'VaultClientApp'

# Check logs
Get-Content C:\vault-client\config\vault-client.log -Tail 50
```

### Expected Success:
```
[INFO] Method 1: Using Invoke-RestMethod with UseDefaultCredentials...
[SUCCESS] SUCCESS: Vault authentication successful via HTTP Negotiate!
[INFO] Client token: hvs.CAES...
[INFO] Token TTL: 3600 seconds
```

OR

```
[INFO] Method 2: Using WebRequest with UseDefaultCredentials...
[SUCCESS] SUCCESS: Vault authentication successful via WebRequest!
[INFO] Client token: hvs.CAES...
```

---

## üìã Current Status Summary

| Component | Status | Notes |
|-----------|--------|-------|
| **Updated Plugin** | ‚úÖ Deployed | SHA256: 0d140e423aa... |
| **HTTP Negotiate Support** | ‚úÖ Enabled | Authorization header passthrough configured |
| **Roles & Policies** | ‚úÖ Created | `vault-gmsa-role`, `default` |
| **Keytab** | ‚ö†Ô∏è Pending | **YOU need to configure this** |
| **Windows Client** | üîÑ Ready to test | Once keytab is added |

---

## ‚ùì Troubleshooting

### If client still shows "spnego token is required":
- **Cause**: Keytab not configured on Vault server
- **Fix**: Follow Option 1 or Option 2 above to add keytab

### If client shows "400 Bad Request" with different error:
- **Check Vault logs**:
  ```bash
  ssh lennart@107.23.32.117
  sudo docker logs c7db14781e99 --tail 100
  ```

### If client shows "permission denied":
- **Cause**: Policy not correctly attached to role
- **Fix**: Update role with correct policy binding

---

## üéØ What to Do RIGHT NOW

1. **Get the keytab base64** (from your earlier work or generate new one)
2. **Configure Vault** with the keytab (see Option 1 above)
3. **Test Windows client**: `Start-ScheduledTask -TaskName 'VaultClientApp'`
4. **Check logs**: Look for `[SUCCESS]` message

The plugin is ready - it just needs the keytab to validate tokens! üöÄ
